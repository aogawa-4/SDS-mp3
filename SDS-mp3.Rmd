---
title: "SDS-mp3"
author: "Aoi Ogawa, Stella Li, Ester Zhao"
date: "4/3/2018"
output: 
  html_document :
    code_folding : hide
---

```{r, message = FALSE, warning = FALSE}

library(tidyverse)
library(sf)
library(macleish)
library(leaflet)
library(rgdal)

```

#Sugar Rush 
aka Pour Some Sugar On Me by Def Leppard
<br>

Maple syrup: New England runs on it. Anyone with a maple in their backyard knows that Autumn is the time to put a tap on the tree. But what circumstances generate the most maple sap? We talked to Reid Bertone-Johnson at the Macleish field station to get the down-low. 

[Insert info from Reid interview on when the most sap is collected]

### Mapping out Macleish

Macleish at Smith College taps their maple trees each year, and we are interested in making the process more time efficient and effective. In order to do this, we are used spatial data from the `macleish` shapefile, which contains information about the man-made and natural structures surrounding the Macleish field station. From this, we used the weather, forest, and sap layers to analyze how climate affects sap yield at Macleish. Our goal is to allow those working at the Macleish field station to predict when the greatest sap yields will be, thus allowing them to prepare for the sap collection with the appropriate materials. We hope to also create a route that will allow for the most efficient sap collection.

Below, we have mapped out the Macleish area with the maple forests highlighted in red, and forests that contain maples highlighted in yellow. Our suggested route allows a worker to travel to all the maple trees in the area surrounding the Macleish field station in the most efficient way.


```{r, message = FALSE, warning = FALSE}
# getting the table of maple syrup data and weather data from macleish

macleish <- etl("macleish")

str(macleish)

macleish %>%
etl_extract() %>%
etl_transform() %>%
etl_load()

whately <- macleish %>%
tbl("whately")

weather <- data.frame(whately)

weather_time <- data.frame(whately)

maple_sap <- data.frame(maple_sap)

```


```{r, message = FALSE, warning = FALSE}
# Mappping the maple tree forests using leaflet
maple_forest <- macleish_layers[["forests"]] %>% 
  filter(VegType_21 == "3")

birch_maple_forest <- macleish_layers[["forests"]] %>% 
  filter(VegType_21 == "13" )


leaflet() %>%
  addTiles() %>%
  addPolygons(data = maple_forest, color = "red") %>%
  addPolygons(data = birch_maple_forest, color = "yellow")
```

Using this route, we hope that workers will be able to visit a larger amount of maple trees per day. The Macleish data showed that several days, maple sap was not collected. Our route will make collection less of a hassle, and possibly open up Macleish maple sap collection as a tourist destination the way that many New England maple forests are.

<br>

### Sap Yield Predictions
We also aimed to compare the difference in daytime temperature and nighttime temperature with the total sap collected on each day. (INSERT REIDâ€™S PREDICTION ON SAP COLLECTION). The graph below shows these compared over the years that maple sap data is provided - this shows that when (INSERT CONCLUSION BASED ON GRAPH). We hope that this data graphic provides some clarity on what conditions tend to yield the most sap.

```{r, message = FALSE, warning = FALSE}
#Separating the date into year, month, and day for clarity
#Filter out NA data for sap

sap <- maple_sap %>% 
  filter(!is.na(sap)) %>%
  separate(when, c("year", "month", "day"), sep = "-")

f_weather <- weather_time %>% 
  separate(when,c("year", "month", "day"), sep = "-") %>%
  separate(day, c("day", "time"), sep = "T")

```



```{r, message = FALSE, warning = FALSE}
#Filter out irrelevant data (only temp and sap is needed)

f_weather$wind_speed <- NULL
f_weather$wind_dir <- NULL
f_weather$rel_humidity <- NULL
f_weather$pressure <- NULL
f_weather$solar_radiation <- NULL
f_weather$rainfall <- NULL

sap_weather <- inner_join(f_weather, sap) 

sap_weather$Comments <- NULL

```


```{r, message = FALSE, warning = FALSE}
#Get the average daytime and nighttime temperatures for each day

daytime_sap_data <- sap_weather %>%
  group_by(year,month,day) %>%
  filter(time >= "06:00:00Z" &
           time <="18:00:00Z") %>% 
  summarize(day_avg_temp = mean(temperature))


nighttime_sap_data <- sap_weather %>%
    group_by(year,month,day) %>%
  filter(time >= "00:00:00Z" &
           time < "06:00:00Z" |
           time > "18:00:00Z" &
           time < "24:00:00Z") %>%
  summarize(night_avg_temp = mean(temperature))
  
#Join daytime and nighttime average temperatures into one data frame
#Calculate the difference between daytime and nighttime average temperatures for each day

final_sap <- inner_join(daytime_sap_data, nighttime_sap_data) %>%
  mutate(temp_diff = day_avg_temp - night_avg_temp)

final_sap <-inner_join(final_sap, sap)


# Join the year, month, and day columns back into one date column
  
final_sap$date <- paste0(final_sap$year, final_sap$month, final_sap$day)
final_sap$date <- ymd(final_sap$date)


final_sap$day <- NULL
# final_sap$year <- NULL 
final_sap$month <- NULL 
final_sap$Comments <- NULL


final_sap <- final_sap[c("year", "date", "day_avg_temp", "night_avg_temp", "temp_diff", "sap", "People")]
 
years_sap <- c("2013", "2014", "2015", "2017")

#Plot the sap yield and the difference in temperature over time
data_sap <- function(year_arg) {
  final_sap %>%
    filter(year == year_arg) %>%
    ggplot(final_sap, aes(x = date)) +
  geom_line(aes(y = temp_diff), colour = "blue") +
  geom_line(aes(y = sap), colour = "orange") +
  labs(x = "Date", y = "Difference in Temperature") +
  scale_y_continuous(sec.axis = sec_axis(~.*5, name = "Sap Yield"))
}

sqp_plots <- lapply(years, data_sap)


```

```{r}
#Plot the sap yield and the difference in temperature over time
ggplot(final_sap, aes (x = date))+ 
  geom_line(aes(y = temp_diff), colour = "blue") +
  geom_line(aes(y = sap), colour = "orange") +
  labs(x = "Date", y = "Difference in Temperature") +
  scale_y_continuous(sec.axis = sec_axis(~.*5, name = "Sap Yield")) + facet_wrap(~ year)


```


```{r}
# reading shapefile

sigar_bush <- st_read("./SugarbushPoly20171013.shp")
```

